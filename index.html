<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fracciones Calc Pro v3.0</title>
    
    <link rel="icon" type="image/png" href="icono.png?v=2">
    <link rel="apple-touch-icon" href="icono.png?v=2">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Fracciones%20Plus%22,%22short_name%22:%22Fracciones%22,%22start_url%22:%22index.html%22,%22display%22:%22standalone%22,%22background_color%22:%22#1a1a1a%22,%22theme_color%22:%22#bdc3c7%22,%22icons%22:[{%22src%22:%22icono.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22,%22purpose%22:%22any%20maskable%22}]}">

    <style>
        :root { --body-bg: #bdc3c7; --lcd-bg: #8fb8c5; --text-color: #111; }
        .dark-mode { --body-bg: #2c3e50; --lcd-bg: #2c3e50; --text-color: #ecf0f1; }

        body { background-color: #1a1a1a; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Arial, sans-serif; overflow: hidden; }
        
        .calc-body { width: 360px; background: var(--body-bg) linear-gradient(135deg, rgba(255,255,255,0.1) 25%, transparent 25%) -50px 0; background-size: 2px 2px; border-radius: 12px; padding-bottom: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.9); border: 1px solid #777; transition: background 0.3s; position: relative; }
        
        .header { height: 35px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-size: 11px; font-weight: bold; color: #444; border-bottom: 1px solid #999; }
        
        /* Pantalla LCD v3.0 */
        .display-container { background-color: var(--lcd-bg); margin: 12px; height: 150px; border: 3px solid #555; border-radius: 4px; display: flex; flex-direction: column; justify-content: flex-end; padding: 10px 15px; box-shadow: inset 0 5px 15px rgba(0,0,0,0.5); position: relative; overflow: hidden; transition: background 0.3s; }
        .display-container::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%); background-size: 100% 3px; pointer-events: none; }
        
        .lcd-btn { position: absolute; top: 5px; font-size: 9px; cursor: pointer; background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; padding: 2px 5px; color: var(--text-color); }
        #btn-dec { left: 5px; }
        #btn-hist { right: 5px; }
        #btn-theme { right: 45px; }

        #process-val { display: flex; align-items: center; justify-content: flex-end; color: rgba(0,0,0,0.45); font-weight: bold; min-height: 25px; transform: scale(0.8); transform-origin: right; font-family: 'Courier New', monospace; }
        .fraction-display { display: flex; align-items: center; justify-content: flex-end; color: var(--text-color); font-weight: bold; width: 100%; margin-bottom: 5px; }
        
        .whole-part { font-size: 2.8rem; }
        .fraction-part { display: flex; flex-direction: column; align-items: center; margin: 0 4px; }
        .num-part { font-size: 1.2rem; border-bottom: 2px solid currentColor; line-height: 1; }
        .den-part { font-size: 1.2rem; line-height: 1; }

        /* Errores */
        .error-flash { background-color: #e74c3c !important; }

        /* Controles de Memoria */
        .mem-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 0 12px 10px; }
        .btn-mem { height: 25px; font-size: 10px; background: #95a5a6; color: white; border-radius: 4px; box-shadow: 0 2px 0 #7f8c8d; }

        .keyboards-grid { display: grid; grid-template-columns: 1fr 1fr; padding: 5px 10px; gap: 10px; }
        .grid-3x4 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        button { height: 48px; border: 1px solid #888; border-radius: 8px; background: linear-gradient(to bottom, #fcfcfc, #bdc3c7); box-shadow: 0 4px 0 #7f8c8d; font-size: 1.2rem; font-weight: bold; color: #2c3e50; cursor: pointer; transition: transform 0.05s; position: relative; }
        button:active { transform: translateY(3px); box-shadow: 0 1px 0 #7f8c8d; }
        
        .btn-red { background: linear-gradient(to bottom, #e74c3c, #c0392b); color: white; box-shadow: 0 4px 0 #962d22; }
        .btn-blue { background: linear-gradient(to bottom, #3498db, #2980b9); color: white; box-shadow: 0 4px 0 #1c5982; }
        .operators-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 15px 10px 0; }
        .btn-op { border-radius: 50%; height: 55px; width: 55px; background: linear-gradient(to bottom, #34495e, #2c3e50); color: white; box-shadow: 0 4px 0 #1a252f; }
        .btn-orange { border-radius: 12px; background: linear-gradient(to bottom, #f39c12, #d35400); color: white; box-shadow: 0 4px 0 #a04000; font-size: 1.8rem; width: 65px; }
        .active-op { background: #f1c40f !important; color: #000 !important; box-shadow: 0 4px 0 #9b810c !important; }
        .visual-divider { border-bottom: 4px solid #7f8c8d; margin: 12px 0; border-radius: 2px; }

        /* Panel de Historial */
        #hist-panel { position: absolute; top: 35px; left: 12px; right: 12px; bottom: 15px; background: rgba(255,255,255,0.95); z-index: 10; border-radius: 8px; display: none; padding: 10px; overflow-y: auto; font-size: 12px; border: 2px solid #555; }
        .hist-item { border-bottom: 1px solid #ddd; padding: 5px 0; cursor: pointer; }
    </style>
</head>
<body>

<div class="calc-body" id="main-body">
    <div id="hist-panel">
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
            <span>HISTORIAL</span>
            <span onclick="toggleHist()" style="cursor:pointer; color:red;">[X]</span>
        </div>
        <div id="hist-content">No hay operaciones.</div>
    </div>

    <div class="header">
        <span>FRACCIONES CALC PRO</span>
        <span class="version-tag">v3.0</span>
    </div>
    
    <div class="display-container" id="lcd">
        <div class="lcd-btn" id="btn-dec" onclick="toggleDecimal()">DEC</div>
        <div class="lcd-btn" id="btn-theme" onclick="toggleTheme()">‚òÄÔ∏è</div>
        <div class="lcd-btn" id="btn-hist" onclick="toggleHist()">üìú</div>
        
        <div id="process-val"></div>
        <div id="main-val" class="fraction-display"><div class="whole-part">0</div></div>
        
        <div style="display:flex; justify-content:space-between; width:100%; border-top:1px solid rgba(0,0,0,0.1); padding-top:5px;">
            <div style="font-size:10px;">Aprox. 1/8: <b id="round-8">-</b></div>
            <div style="font-size:10px;">Aprox. 1/16: <b id="round-16">-</b></div>
        </div>
    </div>

    <div class="mem-row">
        <button class="btn-mem" onclick="memAction('MC')">MC</button>
        <button class="btn-mem" onclick="memAction('MR')">MR</button>
        <button class="btn-mem" onclick="memAction('M+')">M+</button>
        <button class="btn-mem" onclick="memAction('MS')">MS</button>
    </div>

    <div class="keyboards-grid">
        <div class="left-column">
            <div style="height: 12px;"></div> 
            <div class="grid-3x4">
                <button class="btn-red" onclick="action('clearAll')">C</button>
                <button class="btn-blue" onclick="action('toggleSign')">+/-</button>
                <button class="btn-blue" onclick="action('back', 'w')">‚å´</button>
                <button onclick="action('press', 'w', 1)">1</button><button onclick="action('press', 'w', 2)">2</button><button onclick="action('press', 'w', 3)">3</button>
                <button onclick="action('press', 'w', 4)">4</button><button onclick="action('press', 'w', 5)">5</button><button onclick="action('press', 'w', 6)">6</button>
                <button onclick="action('press', 'w', 7)">7</button><button onclick="action('press', 'w', 8)">8</button><button onclick="action('press', 'w', 9)">9</button>
                <button style="grid-column: span 3;" onclick="action('press', 'w', 0)">0</button>
            </div>
        </div>
        <div class="right-column">
            <div class="grid-3x4">
                <button onclick="action('press', 'n', 1)">1</button><button onclick="action('press', 'n', 2)">2</button><button onclick="action('press', 'n', 3)">3</button>
                <button onclick="action('press', 'n', 4)">4</button><button onclick="action('press', 'n', 5)">5</button><button onclick="action('press', 'n', 6)">6</button>
                <button onclick="action('press', 'n', 7)">7</button><button onclick="action('press', 'n', 8)">8</button><button onclick="action('press', 'n', 9)">9</button>
                <button onclick="action('press', 'n', 0)">0</button>
                <button class="btn-blue" style="grid-column: span 2" onclick="action('back', 'n')">‚å´</button>
            </div>
            <div class="visual-divider"></div>
            <div class="grid-3x4">
                <button onclick="action('press', 'd', 1)">1</button><button onclick="action('press', 'd', 2)">2</button><button onclick="action('press', 'd', 3)">3</button>
                <button onclick="action('press', 'd', 4)">4</button><button onclick="action('press', 'd', 5)">5</button><button onclick="action('press', 'd', 6)">6</button>
                <button onclick="action('press', 'd', 7)">7</button><button onclick="action('press', 'd', 8)">8</button><button onclick="action('press', 'd', 9)">9</button>
                <button onclick="action('press', 'd', 0)">0</button>
                <button class="btn-blue" style="grid-column: span 2" onclick="action('back', 'd')">‚å´</button>
            </div>
        </div>
    </div>

    <div class="operators-row">
        <button class="btn-op" id="op-plus" onclick="action('handleOp', '+')">+</button>
        <button class="btn-op" id="op-minus" onclick="action('handleOp', '-')">‚àí</button>
        <button class="btn-op" id="op-mul" onclick="action('handleOp', '*')">√ó</button>
        <button class="btn-op" id="op-div" onclick="action('handleOp', '/')">√∑</button>
        <button class="btn-orange" onclick="action('solve')">=</button>
    </div>
</div>

<script>
    const clickSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFRm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YTdvT18AZmZmf39/f39/f2ZmZg==");
    let currentInput = { w: '0', n: '', d: '' };
    let storedValue = null, activeOperator = null, sign = 1, justSolved = false, memory = null, history = [], isDecimalMode = false;

    function action(fnName, ...args) {
        if ("vibrate" in navigator) navigator.vibrate(20);
        clickSound.currentTime = 0; clickSound.play().catch(() => {});
        window[fnName](...args);
    }

    function toggleTheme() { document.getElementById('main-body').classList.toggle('dark-mode'); document.getElementById('btn-theme').innerText = document.getElementById('main-body').classList.contains('dark-mode') ? "üåô" : "‚òÄÔ∏è"; }
    function toggleHist() { const p = document.getElementById('hist-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    function toggleDecimal() { isDecimalMode = !isDecimalMode; updateDisplay(); }

    function updateDisplay(htmlOverride = null) {
        const main = document.getElementById('main-val');
        if (isDecimalMode && !htmlOverride) {
            let val = (parseInt(currentInput.w) + (currentInput.n / (currentInput.d || 1))) * sign;
            main.innerHTML = `<div class="whole-part">${val.toFixed(4).replace(/\.?0+$/, '')}</div>`;
            return;
        }
        main.innerHTML = htmlOverride || renderFraction(currentInput.w, currentInput.n, currentInput.d, sign);
    }

    function renderFraction(w, n, d, s) {
        let wholeStr = (s === -1 ? '-' : '');
        if (w !== '0' || (n === '' && d === '')) wholeStr += w; else if (s === -1) wholeStr = '-';
        let html = `<div class="whole-part">${wholeStr}</div>`;
        if (n !== '' || d !== '') html += `<div class="fraction-part"><div class="num-part">${n || '0'}</div><div class="den-part">${d || '?'}</div></div>`;
        return html;
    }

    function press(part, val) { if (justSolved) { clearAll(); justSolved = false; } if (currentInput[part] === '0') currentInput[part] = val.toString(); else currentInput[part] += val.toString(); updateDisplay(); }
    function back(part) { currentInput[part] = currentInput[part].slice(0, -1); if (currentInput[part] === '') currentInput[part] = (part === 'w' ? '0' : ''); updateDisplay(); }
    function toggleSign() { sign *= -1; updateDisplay(); }
    function clearAll() { currentInput = { w: '0', n: '', d: '' }; storedValue = null; activeOperator = null; sign = 1; justSolved = false; document.getElementById('process-val').innerHTML = ""; updateDisplay(); document.querySelectorAll('.btn-op').forEach(b => b.classList.remove('active-op')); }

    function handleOp(op) {
        storedValue = { num: (parseInt(currentInput.w) * (parseInt(currentInput.d) || 1) + (parseInt(currentInput.n) || 0)) * sign, den: parseInt(currentInput.d) || 1 };
        activeOperator = op; justSolved = false;
        document.getElementById('process-val').innerHTML = renderFraction(currentInput.w, currentInput.n, currentInput.d, sign) + ` ${op}`;
        currentInput = { w: '0', n: '', d: '' }; sign = 1; updateDisplay();
    }

    function solve() {
        if (!storedValue || !activeOperator) return;
        let second = { num: (parseInt(currentInput.w) * (parseInt(currentInput.d) || 1) + (parseInt(currentInput.n) || 0)) * sign, den: parseInt(currentInput.d) || 1 };
        let resNum, resDen;
        if (activeOperator === '+') { resNum = storedValue.num * second.den + second.num * storedValue.den; resDen = storedValue.den * second.den; }
        else if (activeOperator === '-') { resNum = storedValue.num * second.den - second.num * storedValue.den; resDen = storedValue.den * second.den; }
        else if (activeOperator === '*') { resNum = storedValue.num * second.num; resDen = storedValue.den * second.den; }
        else if (activeOperator === '/') { resNum = storedValue.num * second.den; resDen = storedValue.den * second.num; }

        if (resDen === 0) { showError(); return; }

        let common = gcd(Math.abs(resNum), Math.abs(resDen));
        resNum /= common; resDen /= common;
        
        history.push({n: resNum, d: resDen});
        updateHistoryUI();

        let ent = Math.trunc(resNum / resDen), rem = Math.abs(resNum % resDen);
        updateDisplay(renderFraction(Math.abs(ent).toString(), rem !== 0 ? rem.toString() : '', rem !== 0 ? resDen.toString() : '', resNum < 0 ? -1 : 1));
        
        document.getElementById('round-8').innerText = formatAprox(resNum/resDen, 8);
        document.getElementById('round-16').innerText = formatAprox(resNum/resDen, 16);

        currentInput = { w: Math.abs(ent).toString(), n: rem !== 0 ? rem.toString() : '', d: rem !== 0 ? resDen.toString() : '' };
        sign = resNum < 0 ? -1 : 1; justSolved = true; storedValue = null;
    }

    function gcd(a, b) { return b ? gcd(b, a % b) : a; }
    function formatAprox(val, base) { let total = Math.round(val * base); let ent = Math.trunc(total / base), frac = Math.abs(total % base); if (frac === 0) return ent.toString(); let c = gcd(frac, base); return (ent !== 0 ? ent + " " : "") + (frac/c) + "/" + (base/c); }

    function showError() { const lcd = document.getElementById('lcd'); lcd.classList.add('error-flash'); setTimeout(() => lcd.classList.remove('error-flash'), 500); clearAll(); }
    function updateHistoryUI() { const c = document.getElementById('hist-content'); c.innerHTML = history.slice(-5).reverse().map(h => `<div class="hist-item">${h.n}/${h.d}</div>`).join(''); }
    
    function memAction(type) {
        let val = { n: (parseInt(currentInput.w) * (parseInt(currentInput.d) || 1) + (parseInt(currentInput.n) || 0)) * sign, d: parseInt(currentInput.d) || 1 };
        if (type === 'MS') memory = val;
        if (type === 'MR' && memory) { currentInput.w = Math.trunc(memory.n/memory.d).toString(); currentInput.n = (memory.n%memory.d).toString(); currentInput.d = memory.d.toString(); updateDisplay(); }
        if (type === 'MC') memory = null;
    }
</script>
</body>
</html>
